<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App Musica Classica</title>
    <style>
        body { margin: 0; font-family: -apple-system, system-ui, sans-serif; background: #f0f0f0; color: #1a1a1a; }
        
        /* Struttura Titolo e Ricerca */
        .search-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 15px 5px 15px; /* Spazio ridotto in alto */
            gap: 10px;
        }
        .search-container h2 { margin: 0; font-size: 22px; white-space: nowrap; }
        .search-input {
            flex: 1;
            padding: 8px 12px;
            border-radius: 20px;
            border: 1px solid #ccc;
            font-size: 14px;
            outline: none;
        }

        /* Barre Superiori (fisse) */
        .header-fisso { 
            position: fixed; top: 0; width: 100%; height: 60px; 
            background: #ffffff; color: #000; display: flex; 
            align-items: center; justify-content: space-between; z-index: 1000;
            padding: 0 10px; box-sizing: border-box; border-bottom: 1px solid #ddd;
        }

        /* Liste */
        #schermata-lista, #schermata-composizioni { padding: 10px 15px; }
        .riga-container { 
            display: flex; gap: 10px; margin-bottom: 12px; align-items: stretch;
        }

        /* Pulsanti */
        button { 
            background: white; color: black; border: 1px solid #ccc; 
            padding: 12px; border-radius: 8px; font-size: 15px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        button:active { background: #e0e0e0; }

        .btn-nome-principale { flex: 3; text-align: left; justify-content: flex-start; font-weight: 500; }
        .btn-opere-piccolo { flex: 1; font-size: 12px; text-transform: uppercase; font-weight: bold; min-width: 70px; }
        .btn-header { padding: 6px 10px; font-size: 13px; font-weight: bold; }
        .btn-indietro { background: #f8d7da; border-color: #f5c6cb; }

        /* Iframe */
        .wrap-iframe { margin-top: 60px; width: 100%; height: calc(100vh - 60px); overflow-y: auto; -webkit-overflow-scrolling: touch; }
        iframe { width: 100%; height: 6000px; border: none; pointer-events: none; background: white; }

        .nascosto { display: none !important; }
        #titolo-corrente { font-size: 13px; font-weight: bold; text-align: center; flex: 1; padding: 0 5px; color: #555; }
    </style>
</head>
<body>

    <div id="schermata-lista">
        <div class="search-container">
            <h2>Compositori</h2>
            <input type="text" id="input-ricerca" class="search-input" placeholder="Cerca..." onkeyup="filtraCompositori()">
        </div>
        <div id="lista-corpo" style="margin-top: 10px;"></div>
    </div>

    <div id="schermata-composizioni" class="nascosto">
        <div class="header-fisso">
            <button class="btn-header btn-indietro" onclick="mostraLista()">Lista</button>
            <button class="btn-header" id="btn-comp-vita" style="flex:1; margin: 0 10px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"></button>
            <div style="width:50px"></div>
        </div>
        <div id="lista-brani-corpo" style="margin-top:70px"></div>
    </div>

    <div id="schermata-dettaglio" class="nascosto">
        <div class="header-fisso" id="testata">
            <button class="btn-header btn-indietro" id="btn-back"></button>
            <span id="titolo-corrente"></span>
            <button class="btn-header" id="btn-azione-destra"></button>
        </div>
        <div class="wrap-iframe">
            <iframe id="frame-wiki" src=""></iframe>
        </div>
    </div>

    <script>
        let datiMusica = [];

        fetch('dati.json')
            .then(res => res.json())
            .then(data => {
                datiMusica = data;
                mostraLista();
            });

        function mostraLista() {
            gestisciVisibilita('schermata-lista');
            disegnaLista(datiMusica);
        }

        function filtraCompositori() {
            const testo = document.getElementById('input-ricerca').value.toLowerCase();
            const filtrati = datiMusica.filter(c => c.compositore.toLowerCase().includes(testo));
            disegnaLista(filtrati);
        }

        function disegnaLista(arrayDati) {
            const contenitore = document.getElementById('lista-corpo');
            contenitore.innerHTML = '';

            arrayDati.forEach((item) => {
                // Troviamo l'indice originale nell'array datiMusica per non perdere i riferimenti
                const originalIndex = datiMusica.indexOf(item);
                
                const div = document.createElement('div');
                div.className = 'riga-container';
                div.innerHTML = `
                    <button class="btn-nome-principale" onclick="apriVita(${originalIndex})">${item.compositore}</button>
                    <button class="btn-opere-piccolo" onclick="mostraBrani(${originalIndex})">Opere</button>
                `;
                contenitore.appendChild(div);
            });
        }

        function mostraBrani(indexComp) {
            gestisciVisibilita('schermata-composizioni');
            const comp = datiMusica[indexComp];
            
            const btnVita = document.getElementById('btn-comp-vita');
            btnVita.innerText = comp.compositore;
            btnVita.onclick = () => apriVita(indexComp);

            const contenitore = document.getElementById('lista-brani-corpo');
            contenitore.innerHTML = '';

            comp.composizioni.forEach((brano, indexBrano) => {
                const div = document.createElement('div');
                div.className = 'riga-container';
                div.innerHTML = `<button class="btn-nome-principale" style="flex:1" onclick="apriBrano(${indexComp}, ${indexBrano})">${brano.titolo}</button>`;
                contenitore.appendChild(div);
            });
        }

        function apriVita(index) {
            const comp = datiMusica[index];
            configuraIframe(comp.compositore, comp.link_wiki, "OPERE", () => mostraBrani(index), "LISTA", mostraLista);
        }

        function apriBrano(indexComp, indexBrano) {
            const brano = datiMusica[indexComp].composizioni[indexBrano];
            configuraIframe(brano.titolo, brano.link_wiki_comp, "YOUTUBE", () => window.open(brano.link_youtube, '_blank'), "INDIETRO", () => mostraBrani(indexComp));
        }

        function configuraIframe(titolo, url, txtR, azioneR, txtL, azioneL) {
            gestisciVisibilita('schermata-dettaglio');
            document.getElementById('titolo-corrente').innerText = titolo;
        
            // 1. Assicuriamoci che l'URL sia MOBILE (altrimenti avremo pagina bianca/errore 404)
            let urlMobile = url;
            if (!urlMobile.includes('.m.wikipedia.org') && urlMobile.includes('wikipedia.org')) {
                urlMobile = urlMobile.replace('it.wikipedia.org', 'it.m.wikipedia.org');
            }
            
            // 2. Aggiungiamo il parametro per ESPANDERE tutte le sezioni su mobile
            // Il parametro "sections=all" forza l'apertura dei capitoli
            if (urlMobile.includes('wikipedia.org')) {
                if (urlMobile.includes('?')) {
                    urlMobile += "&sections=all";
                } else {
                    urlMobile += "?sections=all";
                }
            }
        
            document.getElementById('frame-wiki').src = urlMobile;
            
            const btnL = document.getElementById('btn-back');
            btnL.innerText = txtL;
            btnL.onclick = azioneL;
        
            const btnR = document.getElementById('btn-azione-destra');
            btnR.innerText = txtR;
            btnR.onclick = azioneR;
            
            document.querySelector('.wrap-iframe').scrollTop = 0;
        }

        function gestisciVisibilita(idMostrare) {
            ['schermata-lista', 'schermata-composizioni', 'schermata-dettaglio'].forEach(id => {
                document.getElementById(id).classList.add('nascosto');
            });
            document.getElementById(idMostrare).classList.remove('nascosto');
        }
    </script>
</body>
</html>